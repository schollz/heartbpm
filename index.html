<html>

<head>
</head>

<body>
    <div id="app">
        <p>{{message}}</p>
        <input v-model="tempo" id="tempo" type="number" min=1 max=300>
        {{ tempo }}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
    var globalTempo = 90;
    var interval = 60000 / globalTempo / 24; // ms
    var expected = Date.now() + interval;

    function step() {
        var dt = Date.now() - expected; // the drift (positive for overshooting)
        if (dt > interval) {
            // something really bad happened. Maybe the browser (tab) was inactive?
            // possibly special handling to avoid futile "catch up" run
        }
        for (var i = 0; i < WebMidi.outputs.length; i++) {
            WebMidi.outputs[i].sendClock();
        }
        expected += interval;
        setTimeout(step, Math.max(0, interval - dt)); // take into account drift
    }



    var app = new Vue({
        el: '#app',
        data: {
            message: "",
            tempo: 90,
        },
        mounted: function() {
            console.log("loaded");
            var _this = this;
            WebMidi.enable(function(err) {
                if (err) {
                    _this.message = "WebMidi could not be enabled: " + err;
                } else {
                    _this.message = "WebMidi enabled!";
                    console.log(WebMidi.outputs);
                    setTimeout(step, interval);
                }
            });
        },
        created: function() {
            this.debouncedChangeTempo = _.debounce(this.changeTempo, 500)
        },
        watch: {
            tempo: function(val) {
                this.debouncedChangeTempo();
            },
        },
        methods: {
            changeTempo: function() {
                console.log("changing tempo to " + this.tempo);
                globalTempo = this.tempo;
                interval = 60000 / globalTempo / 24;
            },
        },
    })
    </script>
</body>

</html>